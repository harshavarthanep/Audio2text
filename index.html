<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Audio Transcriber</title>
    <style>
        :root {
            --primary: #2563eb; /* Royal Blue */
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --success: #16a34a;
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #0f172a;
            --border-radius: 12px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .app-container {
            background: var(--card-bg);
            width: 100%;
            max-width: 900px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 1.5rem 2rem;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 { margin: 0; font-size: 1.4rem; font-weight: 600; letter-spacing: 0.5px; }
        .badge { background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; }

        /* Main Content */
        .main-content { padding: 2rem; display: flex; flex-direction: column; gap: 1.5rem; }

        /* File Upload Zone */
        .upload-zone {
            border: 2px dashed #cbd5e1;
            border-radius: var(--border-radius);
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            background: #f8fafc;
            cursor: pointer;
            position: relative;
        }

        .upload-zone:hover { border-color: var(--primary); background: #eff6ff; }
        .upload-zone input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .upload-icon { font-size: 2.5rem; margin-bottom: 0.5rem; display: block; }
        .file-info { font-weight: 600; color: var(--primary); display: none; margin-top: 10px; }

        /* Audio Player Styling */
        #audioPlayer { width: 100%; margin-top: 10px; display: none; border-radius: 8px; }

        /* Toolbar */
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            align-items: center;
        }

        button {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        .btn-start { background-color: var(--primary); color: white; }
        .btn-start:hover { background-color: var(--primary-dark); transform: translateY(-1px); }
        
        .btn-stop { background-color: #ef4444; color: white; display: none; }
        .btn-stop:hover { background-color: #dc2626; }

        .btn-action { background-color: white; border: 1px solid #cbd5e1; color: var(--secondary); }
        .btn-action:hover { border-color: var(--primary); color: var(--primary); background: white; }

        .spacer { flex-grow: 1; }

        /* Text Area */
        .editor-container { position: relative; flex-grow: 1; }
        
        textarea {
            width: 100%;
            height: 400px;
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1.05rem;
            line-height: 1.7;
            color: #334155;
            resize: vertical;
            outline: none;
            box-sizing: border-box;
            background: #fafafa;
            font-family: inherit;
        }

        textarea:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }

        /* Status & Hints */
        .status-bar {
            margin-top: -10px;
            font-size: 0.9rem;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .pulse { width: 10px; height: 10px; background: #ef4444; border-radius: 50%; display: none; animation: pulse 1.5s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        /* Mobile Adjustments */
        @media (max-width: 600px) {
            .toolbar { flex-direction: column; align-items: stretch; }
            .upload-zone { padding: 1rem; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <h1>üéôÔ∏è Pro Transcriber</h1>
        <span class="badge">V 2.0</span>
    </header>

    <div class="main-content">
        
        <div class="upload-zone" id="dropZone">
            <span class="upload-icon">üìÇ</span>
            <div id="uploadText">
                <strong>Click to Upload Audio</strong> or drag and drop here<br>
                <small style="color: #94a3b8">(Supports MP3, WAV, M4A - Unlimited Size)</small>
            </div>
            <div id="fileInfo" class="file-info"></div>
            <input type="file" id="audioInput" accept="audio/*,video/*">
        </div>

        <audio id="audioPlayer" controls></audio>

        <div class="status-bar">
            <div class="pulse" id="recordingIndicator"></div>
            <span id="statusMessage">Ready to start.</span>
        </div>

        <div class="toolbar">
            <button id="startBtn" class="btn-start" onclick="startProcess()">
                <span>‚ñ∂ Start Transcription</span>
            </button>
            <button id="stopBtn" class="btn-stop" onclick="stopProcess()">
                <span>‚èπ Stop</span>
            </button>
            <button class="btn-action" onclick="toggleMicMode()" id="micToggleBtn">
                üé§ Switch to Mic Only
            </button>
            
            <div class="spacer"></div>

            <button class="btn-action" onclick="copyToClipboard()">
                üìã Copy
            </button>
            <button class="btn-action" onclick="downloadAsWord()">
                üíæ Save as Word
            </button>
        </div>

        <div class="editor-container">
            <textarea id="transcript" placeholder="Transcription will appear here..."></textarea>
        </div>
    </div>
</div>

<script>
    /**
     * STATE MANAGEMENT
     */
    const state = {
        isRecording: false,
        isMicMode: false,
        finalTranscript: '',
        interimTranscript: '',
        recognition: null,
        ignoreEndEvent: false
    };

    // DOM Elements
    const els = {
        audioInput: document.getElementById('audioInput'),
        audioPlayer: document.getElementById('audioPlayer'),
        transcript: document.getElementById('transcript'),
        startBtn: document.getElementById('startBtn'),
        stopBtn: document.getElementById('stopBtn'),
        statusMsg: document.getElementById('statusMessage'),
        pulse: document.getElementById('recordingIndicator'),
        uploadText: document.getElementById('uploadText'),
        fileInfo: document.getElementById('fileInfo'),
        micToggleBtn: document.getElementById('micToggleBtn')
    };

    /**
     * INITIALIZATION & SPEECH API SETUP
     */
    function initSpeech() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            alert("Your browser does not support Speech-to-Text. Please use Google Chrome or Edge.");
            return null;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        
        recognition.continuous = true;     // Keep listening even if user pauses
        recognition.interimResults = true; // Show words as they are being spoken
        recognition.lang = 'en-US';        // Default Language

        recognition.onstart = function() {
            state.isRecording = true;
            updateUIState(true);
        };

        recognition.onerror = function(event) {
            console.error("Speech Error", event.error);
            if (event.error === 'no-speech') {
                state.ignoreEndEvent = true;
            } else {
                els.statusMsg.innerText = "Error: " + event.error;
            }
        };

        recognition.onend = function() {
            state.isRecording = false;
            // Auto-restart if audio file is still playing (Keep Alive Logic)
            if (!state.isMicMode && !els.audioPlayer.paused && !state.ignoreEndEvent) {
                recognition.start();
            } else {
                updateUIState(false);
            }
            state.ignoreEndEvent = false;
        };

        recognition.onresult = function(event) {
            let interim = '';
            
            // Loop through results starting from the current result index
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    state.finalTranscript += event.results[i][0].transcript + ' ';
                } else {
                    interim += event.results[i][0].transcript;
                }
            }

            // Update Text Area safely
            // We combine the Safe Final Transcript + Current Interim
            els.transcript.value = state.finalTranscript + interim;
            
            // Auto Scroll
            els.transcript.scrollTop = els.transcript.scrollHeight;
        };

        return recognition;
    }

    state.recognition = initSpeech();

    /**
     * FILE HANDLING
     */
    els.audioInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        // Use URL.createObjectURL for large file support (Streams file, doesn't load to RAM)
        const fileURL = URL.createObjectURL(file);
        
        els.audioPlayer.src = fileURL;
        els.audioPlayer.style.display = 'block';
        
        // Update UI
        els.uploadText.style.display = 'none';
        els.fileInfo.style.display = 'block';
        els.fileInfo.innerText = "Loaded: " + file.name;
        
        els.statusMsg.innerText = "File loaded. Turn up your volume and click Start.";
        state.isMicMode = false;
        els.micToggleBtn.innerText = "üé§ Switch to Mic Only";
    });

    /**
     * CORE FUNCTIONS
     */

    function startProcess() {
        if (!state.recognition) return;

        if (state.isMicMode) {
            // Pure Mic Mode
            state.recognition.start();
            els.statusMsg.innerText = "Listening to microphone...";
        } else {
            // File Mode
            if (!els.audioPlayer.src) {
                alert("Please upload an audio file first, or switch to Mic mode.");
                return;
            }
            els.audioPlayer.play();
            state.recognition.start();
            els.statusMsg.innerText = "Playing audio & Transcribing...";
        }
    }

    function stopProcess() {
        if (state.recognition) {
            state.recognition.stop();
            // Force stop loop logic
            state.ignoreEndEvent = true; 
        }
        if (!state.isMicMode) {
            els.audioPlayer.pause();
        }
        updateUIState(false);
    }

    function toggleMicMode() {
        state.isMicMode = !state.isMicMode;
        
        if (state.isMicMode) {
            els.audioPlayer.style.display = 'none';
            els.audioPlayer.pause();
            els.uploadText.style.display = 'block';
            els.fileInfo.style.display = 'none';
            els.micToggleBtn.innerText = "üìÇ Switch to File Upload";
            els.micToggleBtn.style.background = "#e0e7ff";
            els.micToggleBtn.style.color = "var(--primary)";
            els.statusMsg.innerText = "Microphone Mode active.";
        } else {
            els.audioPlayer.style.display = els.audioPlayer.src ? 'block' : 'none';
            els.micToggleBtn.innerText = "üé§ Switch to Mic Only";
            els.micToggleBtn.style.background = "white";
            els.micToggleBtn.style.color = "var(--secondary)";
            els.statusMsg.innerText = "File Mode active.";
        }
    }

    /**
     * UI HELPERS
     */
    function updateUIState(isRecording) {
        if (isRecording) {
            els.startBtn.style.display = 'none';
            els.stopBtn.style.display = 'flex';
            els.pulse.style.display = 'block';
            els.transcript.style.borderColor = "var(--success)";
        } else {
            els.startBtn.style.display = 'flex';
            els.stopBtn.style.display = 'none';
            els.pulse.style.display = 'none';
            els.statusMsg.innerText = "Stopped.";
            els.transcript.style.borderColor = "#e2e8f0";
        }
    }

    /**
     * EXPORT & UTILS
     */
    function copyToClipboard() {
        if (!els.transcript.value) return;
        els.transcript.select();
        document.execCommand('copy'); // Legacy support
        if(navigator.clipboard) navigator.clipboard.writeText(els.transcript.value);
        
        const originalText = els.statusMsg.innerText;
        els.statusMsg.innerText = "‚úÖ Copied to clipboard!";
        setTimeout(() => els.statusMsg.innerText = originalText, 2000);
    }

    function downloadAsWord() {
        const content = els.transcript.value;
        if (!content) {
            alert("No text to download!");
            return;
        }

        // Professional HTML Wrapper for Word with UTF-8 BOM
        const header = `
            <html xmlns:o='urn:schemas-microsoft-com:office:office' 
                  xmlns:w='urn:schemas-microsoft-com:office:word' 
                  xmlns='http://www.w3.org/TR/REC-html40'>
            <head><meta charset='utf-8'><title>Transcript</title>
            <style>body { font-family: Arial, sans-serif; font-size: 12pt; }</style>
            </head><body>`;
            
        const footer = "</body></html>";
        
        // Convert newlines to breaks for Word
        const formattedContent = content.replace(/\n/g, "<br>");
        const sourceHTML = header + formattedContent + footer;

        const blob = new Blob(['\ufeff', sourceHTML], { type: 'application/msword' });
        
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        
        const now = new Date();
        const filename = `Transcript_${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}.doc`;
        
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Initialize state
    els.transcript.value = '';
</script>

</body>
</html>
